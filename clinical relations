import streamlit as st
import pandas as pd
import uuid
import re

# Initialize session state for the medicines database
if 'medicines_db' not in st.session_state:
    st.session_state.medicines_db = pd.DataFrame({
        "ID": [str(uuid.uuid4())[:8] for _ in range(10)],
        "Medicine Name": [
            "Paracetamol", "Ibuprofen", "Aspirin", "Cetirizine", "Amoxicillin",
            "Metformin", "Omeprazole", "Losartan", "Atorvastatin", "Naproxen"
        ],
        "Purpose": [
            "Pain Relief", "Anti-inflammatory", "Blood Thinner", "Allergy Relief", "Antibiotic",
            "Diabetes Control", "Acid Reflux", "Blood Pressure Control", "Cholesterol Control", "Pain Relief"
        ],
        "Legal Status": [
            "OTC", "OTC", "OTC", "OTC", "Prescription",
            "Prescription", "Prescription", "Prescription", "Prescription", "OTC"
        ],
        "Alternatives": [
            "Acetaminophen", "Naproxen", "Clopidogrel", "Loratadine", "Ciprofloxacin",
            "Gliclazide", "Pantoprazole", "Valsartan", "Rosuvastatin", "Ibuprofen"
        ],
        "Detailed Description": [
            "Used for pain relief and fever reduction. Overdoses can cause liver damage.",
            "NSAID for pain relief, fever reduction, and inflammation control.",
            "Pain reliever, anti-inflammatory, and blood thinner; prevents heart attacks.",
            "Antihistamine for allergy relief like sneezing and itchy eyes.",
            "Prescription antibiotic for bacterial infections like respiratory issues.",
            "Diabetes medication to help control blood sugar levels.",
            "Reduces stomach acid for acid reflux and ulcers.",
            "Lowers blood pressure and protects kidneys in diabetic patients.",
            "Cholesterol-lowering medication to reduce heart disease risk.",
            "NSAID for pain relief, commonly used for arthritis and muscle pain."
        ]
    })

medicines_db = st.session_state.medicines_db

# Sidebar Navigation with Icons
st.sidebar.title("ğŸ—‚ï¸ Navigation")
page = st.sidebar.radio("Go to", [
    "ğŸ  Home", "ğŸ” Medicine Search", "ğŸ“Š Medicine Database", "âš–ï¸ Medicine Comparison", "â• Add Medicine", "ğŸ—‘ï¸ Delete Medicine", "âœï¸ Update Medicine"
])

if page == "ğŸ  Home":
    st.title("ğŸ’Š Clinical Advisor")
    st.subheader("Your Personal Medicine Guide")
    st.markdown(""" 
    - **ğŸ” Search and compare medicines.**
    - **ğŸ“œ Check legal status and alternative options.**
    - **ğŸ“‹ Manage your medicine database easily.**
    """)
    st.image("https://t3.ftcdn.net/jpg/03/36/92/66/360_F_336926699_hsKUK1gdTZ5esb1LAUt5PhOmLEkstVOR.jpg", caption="Stay safe, stay informed!")

elif page == "ğŸ” Medicine Search":
    st.title("ğŸ” Medicine Search")
    col1, col2 = st.columns([3, 1])
    with col1:
        search_query = st.text_input("Search for a medicine", placeholder="Type medicine name...")
    with col2:
        legal_filter = st.selectbox("Filter by Legal Status", ["All", "OTC", "Prescription"], index=0)
    
    filtered_medicines = medicines_db
    if search_query:
        filtered_medicines = filtered_medicines[filtered_medicines["Medicine Name"].str.contains(search_query, case=False, na=False)]
    if legal_filter != "All":
        filtered_medicines = filtered_medicines[filtered_medicines["Legal Status"] == legal_filter]
    
    if not filtered_medicines.empty:
        selected_medicine = st.selectbox("Select Medicine", filtered_medicines["Medicine Name"])
        medicine_details = medicines_db[medicines_db["Medicine Name"] == selected_medicine].iloc[0]
        st.write(f"**ğŸ†” ID:** {medicine_details['ID']}")
        st.write(f"**ğŸ’Š Name:** {medicine_details['Medicine Name']}")
        st.write(f"**ğŸ”¹ Purpose:** {medicine_details['Purpose']}")
        st.write(f"**ğŸ“œ Legal Status:** {medicine_details['Legal Status']}")
        st.write(f"**ğŸ”„ Alternatives:** {medicine_details['Alternatives']}")
        st.write(f"**ğŸ“– Description:** {medicine_details['Detailed Description']}")
    else:
        st.warning("âš ï¸ No medicine found. Try adjusting your search criteria.")

elif page == "â• Add Medicine":
    st.title("â• Add Medicine")
    
    with st.form("add_medicine_form", clear_on_submit=True):
        new_name = st.text_input("Medicine Name").strip()
        new_purpose = st.text_input("Purpose").strip()
        new_legal_status = st.selectbox("Legal Status", ["OTC", "Prescription"])
        new_alternatives = st.text_input("Alternatives").strip()
        new_description = st.text_area("Detailed Description").strip()
        submitted = st.form_submit_button("âœ… Add Medicine")
        
        if submitted:
            if not new_name or new_name in medicines_db["Medicine Name"].values or not re.match("^[a-zA-Z0-9 ]+$", new_name):
                st.error("ğŸš¨ Invalid medicine name! Ensure it's unique and contains only letters/numbers.")
            elif not new_purpose or not new_description:
                st.error("ğŸš¨ Please fill out all fields, including Purpose and Description.")
            else:
                new_data = pd.DataFrame([{
                    "ID": str(uuid.uuid4())[:8], 
                    "Medicine Name": new_name, 
                    "Purpose": new_purpose, 
                    "Legal Status": new_legal_status, 
                    "Alternatives": new_alternatives, 
                    "Detailed Description": new_description 
                }])
                st.session_state.medicines_db = pd.concat([st.session_state.medicines_db, new_data], ignore_index=True)
                st.success(f"âœ… Medicine '{new_name}' added successfully!")

elif page == "âœï¸ Update Medicine":
    st.title("âœï¸ Update Medicine")
    
    medicine_to_update = st.selectbox("Select Medicine to Update", medicines_db["Medicine Name"].unique())
    medicine_details = medicines_db[medicines_db["Medicine Name"] == medicine_to_update].iloc[0]
    
    with st.form("update_medicine_form", clear_on_submit=True):
        updated_name = st.text_input("Medicine Name", value=medicine_details["Medicine Name"]).strip()
        updated_purpose = st.text_input("Purpose", value=medicine_details["Purpose"]).strip()
        updated_legal_status = st.selectbox("Legal Status", ["OTC", "Prescription"], index=["OTC", "Prescription"].index(medicine_details["Legal Status"]))
        updated_alternatives = st.text_input("Alternatives", value=medicine_details["Alternatives"]).strip()
        updated_description = st.text_area("Detailed Description", value=medicine_details["Detailed Description"]).strip()
        submitted = st.form_submit_button("âœ… Update Medicine")
        
        if submitted:
            if not updated_name or updated_name in medicines_db["Medicine Name"].values or not re.match("^[a-zA-Z0-9 ]+$", updated_name):
                st.error("ğŸš¨ Invalid medicine name! Ensure it's unique and contains only letters/numbers.")
            elif not updated_purpose or not updated_description:
                st.error("ğŸš¨ Please fill out all fields, including Purpose and Description.")
            else:
                # Update the selected medicine details
                medicines_db.loc[medicines_db["Medicine Name"] == medicine_to_update, ["Medicine Name", "Purpose", "Legal Status", "Alternatives", "Detailed Description"]] = [updated_name, updated_purpose, updated_legal_status, updated_alternatives, updated_description]
                st.session_state.medicines_db = medicines_db
                st.success(f"âœ… Medicine '{updated_name}' updated successfully!")

elif page == "ğŸ“Š Medicine Database":
    st.title("ğŸ“Š Medicine Database")
    st.dataframe(medicines_db.style.set_properties(**{'text-align': 'left'}))
    
    csv = medicines_db.to_csv(index=False).encode('utf-8')
    st.download_button(label="ğŸ“¥ Download Database as CSV", data=csv, file_name='medicines_db.csv', mime='text/csv')

elif page == "âš–ï¸ Medicine Comparison":
    st.title("âš–ï¸ Medicine Comparison")
    col1, col2 = st.columns(2)
    
    with col1:
        med1 = st.selectbox("Select first medicine", medicines_db["Medicine Name"].unique(), key="comp1")
    with col2:
        med2 = st.selectbox("Select second medicine", medicines_db["Medicine Name"].unique(), key="comp2")
    
    if med1 and med2:
        details1 = medicines_db[medicines_db["Medicine Name"] == med1].iloc[0]
        details2 = medicines_db[medicines_db["Medicine Name"] == med2].iloc[0]
        
        comp_df = pd.DataFrame({
            "Attribute": ["Medicine Name", "Purpose", "Legal Status", "Alternatives", "Description"],
            f"{med1}": [details1["Medicine Name"], details1["Purpose"], details1["Legal Status"], details1["Alternatives"], details1["Detailed Description"]],
            f"{med2}": [details2["Medicine Name"], details2["Purpose"], details2["Legal Status"], details2["Alternatives"], details2["Detailed Description"]]
        })
        
        st.table(comp_df)

elif page == "ğŸ—‘ï¸ Delete Medicine":
    st.title("ğŸ—‘ï¸ Delete Medicine")
    medicine_to_delete = st.selectbox("Select Medicine to Delete", medicines_db["Medicine Name"].unique())
    
    if st.button("ğŸ—‘ï¸ Delete Medicine", key="delete_button", help="This action is irreversible"):
        confirm_delete = st.checkbox(f"Are you sure you want to delete '{medicine_to_delete}'?")
        if confirm_delete:
            st.session_state.medicines_db = medicines_db[medicines_db["Medicine Name"] != medicine_to_delete].reset_index(drop=True)
            st.success(f"âœ… Medicine '{medicine_to_delete}' deleted successfully!")
        else:
            st.warning("âŒ Deletion not confirmed. Medicine not deleted.")
